---
phase: 05-odoo-validation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified: [main.py]
autonomous: true
---

<objective>
Implement field existence validation and dotted path traversal for Odoo domains.

Purpose: Validate that fields referenced in domains actually exist on the specified model, and that dotted paths traverse valid relations.
Output: validate_field() and validate_path() functions integrated with OdooConnection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-odoo-validation/05-01-SUMMARY.md
@main.py

**Phase 5 Requirements (this plan):**
- VALID-03: Validate field existence on specified model
- VALID-05: Validate dotted path traversal (relations exist along the path)

**Odoo API for field introspection:**
- `model.fields_get()` returns dict of {field_name: field_info}
- field_info contains: type, relation (for Many2one/One2many/Many2many), string (label)
- Relational types: many2one, one2many, many2many
- To traverse: get field type, if relational, get 'relation' comodel and call fields_get on it

**Example fields_get response:**
```python
{
    'name': {'type': 'char', 'string': 'Name'},
    'company_id': {'type': 'many2one', 'relation': 'res.company', 'string': 'Company'},
    'user_ids': {'type': 'many2many', 'relation': 'res.users', 'string': 'Users'},
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fields_get and field validation to OdooConnection</name>
  <files>main.py</files>
  <action>
    Extend OdooConnection class:

    1. Add `get_fields(model_name)` method:
       - Use execute_kw to call fields_get on the model
       - Return dict of field_name -> field_info
       - Cache results to avoid repeated calls

    2. Add `validate_field(model_name, field_name)` method:
       - Get fields for model
       - Check if field_name exists in fields
       - Return (valid: bool, field_info: dict | None, error: str | None)

    3. Add `validate_path(model_name, field_path)` method:
       - Split path by '.'
       - For each segment:
         - Validate field exists on current model
         - If not last segment, check field is relational (many2one, one2many, many2many)
         - Get 'relation' model and continue
       - Return (valid: bool, field_info: dict | None, error: str | None)
       - Error should indicate which segment failed

    Handle common issues:
    - Model not found -> "Model '{model}' not found"
    - Field not found -> "Field '{field}' does not exist on {model}"
    - Non-relational in path -> "Cannot traverse '{field}' - not a relational field"
  </action>
  <verify>
    python -c "
    from main import OdooConnection
    conn = OdooConnection('http://localhost:8069', 'your_db', 'admin', 'admin')
    conn.authenticate()

    # Test single field
    valid, info, err = conn.validate_field('res.partner', 'name')
    print(f'name on res.partner: valid={valid}')

    # Test path
    valid, info, err = conn.validate_path('res.partner', 'company_id.name')
    print(f'company_id.name: valid={valid}')

    # Test invalid
    valid, info, err = conn.validate_field('res.partner', 'nonexistent')
    print(f'nonexistent: valid={valid}, error={err}')
    "
  </verify>
  <done>OdooConnection has get_fields, validate_field, validate_path methods that work correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add model input and validation display to GUI</name>
  <files>main.py</files>
  <action>
    Extend GUI for validation:

    1. Add "Model" input field to main layout (above domain input):
       - Label: "Model (for validation):"
       - Input field, e.g., "res.partner"
       - Optional - validation only runs if model is specified and connection configured

    2. Add "Validate" button (or checkbox to enable auto-validation on Convert)

    3. When validating:
       - Parse domain to extract field names from conditions
       - For each field, call validate_field or validate_path
       - Collect validation results

    4. Display validation results:
       - Show warnings/errors below output
       - Format: "Warning: Field 'xyz' does not exist on res.partner"
       - Or: "Warning: Cannot traverse 'abc.def' - 'abc' is not a relational field"

    5. Don't block conversion - validation is informational only
  </action>
  <verify>
    Run GUI manually:
    python main.py
    - Configure connection in Settings
    - Enter model: res.partner
    - Enter domain: [('nonexistent_field', '=', 1)]
    - Click Validate
    - Should show warning about nonexistent field
  </verify>
  <done>Model input visible, Validate button works, validation warnings display correctly</done>
</task>

</tasks>

<verification>
```bash
# Run all tests
python -m pytest tests/ -v --tb=short

# Manual validation test
python -c "
from main import OdooConnection, parse_domain

# Connect
conn = OdooConnection('http://localhost:8069', 'your_db', 'admin', 'admin')
conn.authenticate()

# Test field validation
domain = parse_domain(\"[('company_id.name', '=', 'Test')]\")
for item in domain:
    if isinstance(item, tuple):
        field = item[0]
        valid, info, err = conn.validate_path('res.partner', field)
        print(f'{field}: {\"valid\" if valid else err}')
"
```
</verification>

<success_criteria>
- get_fields() returns field dict from Odoo
- validate_field() correctly identifies valid/invalid fields
- validate_path() correctly traverses dotted paths
- GUI has Model input field
- Validate button triggers validation
- Validation warnings display in GUI
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-odoo-validation/05-02-SUMMARY.md` with:
- Field validation implementation details
- GUI changes for model input and validation display
- Any API challenges encountered
- Commits produced
- Requirements satisfied: VALID-03, VALID-05
</output>
